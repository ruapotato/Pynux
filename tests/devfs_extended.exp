#!/usr/bin/expect -f
# Extended DevFS Tests

set timeout 10

spawn qemu-system-arm -machine mps2-an385 -cpu cortex-m3 -nographic -semihosting -kernel build/pynux.elf

# Wait for shell prompt
expect "pynux:/>"

# Test accelerometer
send "cat /dev/sensors/accel0\r"
expect {
    -re {-?[0-9]+ -?[0-9]+ -?[0-9]+} { puts "PASS: accel0 returns X Y Z values" }
    timeout { puts "FAIL: accel0 read failed"; exit 1 }
}
expect "pynux:/>"

# Test light sensor
send "cat /dev/sensors/light0\r"
expect {
    -re {[0-9]+} { puts "PASS: light0 returns numeric value" }
    timeout { puts "FAIL: light0 read failed"; exit 1 }
}
expect "pynux:/>"

# Test DC motor read (initial should be 0)
send "cat /dev/motors/dc0\r"
expect {
    "0" { puts "PASS: dc0 initial speed is 0" }
    timeout { puts "FAIL: dc0 read failed"; exit 1 }
}
expect "pynux:/>"

# Test DC motor write
send "echo 75 > /dev/motors/dc0\r"
expect {
    "OK" { puts "PASS: dc0 write succeeded" }
    timeout { puts "FAIL: dc0 write failed"; exit 1 }
}
expect "pynux:/>"

# Verify DC motor speed
send "cat /dev/motors/dc0\r"
expect {
    "75" { puts "PASS: dc0 speed is 75" }
    timeout { puts "FAIL: dc0 should show 75"; exit 1 }
}
expect "pynux:/>"

# Test non-existent device (should show file not found)
send "cat /dev/sensors/invalid\r"
expect {
    -re {not found|No such|does not} { puts "PASS: non-existent device handled" }
    "pynux:/>" { puts "PASS: non-existent device returns to prompt" }
    timeout { puts "FAIL: should handle missing device"; exit 1 }
}

# Test drivers reload
send "drivers reload\r"
expect {
    "Reloading" { puts "PASS: drivers reload started" }
    timeout { puts "FAIL: drivers reload failed"; exit 1 }
}
expect "pynux:/>"

# Test GPIO toggle (write 0 after 1)
send "echo 0 > /dev/gpio/pin0\r"
expect "OK"
expect "pynux:/>"

send "cat /dev/gpio/pin0\r"
expect {
    "0" { puts "PASS: gpio pin0 is 0 after toggle" }
    timeout { puts "FAIL: gpio toggle failed"; exit 1 }
}
expect "pynux:/>"

puts "\n=== All extended tests passed! ==="

send "\003"
close
wait
exit 0
