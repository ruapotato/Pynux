#!/usr/bin/expect -f
# Test driver config file loading and reload functionality

set timeout 10

spawn qemu-system-arm -machine mps2-an385 -cpu cortex-m3 -nographic -semihosting -kernel build/pynux.elf

expect "pynux:/>"

# Check initial driver count (should be 9 default devices)
send "drivers\r"
expect {
    "Total: 9" { puts "PASS: 9 default drivers loaded" }
    timeout { puts "FAIL: should have 9 default drivers"; exit 1 }
}
expect "pynux:/>"

# Verify /etc/drivers directory exists
send "ls /etc/drivers\r"
expect "pynux:/>"
puts "PASS: /etc/drivers directory exists"

# Test reload maintains device count
send "drivers reload\r"
expect {
    "9 driver(s) loaded" { puts "PASS: reload maintains 9 drivers" }
    timeout { puts "FAIL: reload failed"; exit 1 }
}
expect "pynux:/>"

# Verify all default device paths are present
send "drivers\r"
expect "/dev/gpio/pin0"
expect "/dev/gpio/pin1"
expect "/dev/gpio/pin2"
expect "/dev/gpio/pin3"
expect "/dev/sensors/temp0"
expect "/dev/sensors/accel0"
expect "/dev/sensors/light0"
expect "/dev/motors/servo0"
expect "/dev/motors/dc0"
expect "pynux:/>"
puts "PASS: all default device paths present"

# Verify all device types are correct
send "drivers\r"
expect "(gpio)"
expect "(temp)"
expect "(accel)"
expect "(light)"
expect "(servo)"
expect "(dc)"
expect "pynux:/>"
puts "PASS: all device types correct"

puts "\n=== Driver configuration tests passed! ==="

send "\003"
close
wait
exit 0
