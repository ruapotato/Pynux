#!/usr/bin/expect -f
# Edge case tests for DevFS

set timeout 10

spawn qemu-system-arm -machine mps2-an385 -cpu cortex-m3 -nographic -semihosting -kernel build/pynux.elf

expect "pynux:/>"

# Test 1: Servo boundary - over 180 should clamp to 180
send "echo 200 > /dev/motors/servo0\r"
expect "OK"
expect "pynux:/>"
send "cat /dev/motors/servo0\r"
expect {
    "180" { puts "PASS: servo clamped to 180" }
    timeout { puts "FAIL: servo should clamp to 180"; exit 1 }
}
expect "pynux:/>"

# Test 2: Servo boundary - 0 should work
send "echo 0 > /dev/motors/servo0\r"
expect "OK"
expect "pynux:/>"
send "cat /dev/motors/servo0\r"
expect {
    "0" { puts "PASS: servo at 0" }
    timeout { puts "FAIL: servo should be 0"; exit 1 }
}
expect "pynux:/>"

# Test 3: DC motor negative speed
send "echo -50 > /dev/motors/dc0\r"
expect "OK"
expect "pynux:/>"
send "cat /dev/motors/dc0\r"
expect {
    -ex "-50" { puts "PASS: dc motor negative speed" }
    timeout { puts "FAIL: dc motor should show -50"; exit 1 }
}
expect "pynux:/>"

# Test 4: DC motor over 100 should clamp
send "echo 150 > /dev/motors/dc0\r"
expect "OK"
expect "pynux:/>"
send "cat /dev/motors/dc0\r"
expect {
    "100" { puts "PASS: dc motor clamped to 100" }
    timeout { puts "FAIL: dc motor should clamp to 100"; exit 1 }
}
expect "pynux:/>"

# Test 5: DC motor under -100 should clamp
send "echo -150 > /dev/motors/dc0\r"
expect "OK"
expect "pynux:/>"
send "cat /dev/motors/dc0\r"
expect {
    -ex "-100" { puts "PASS: dc motor clamped to -100" }
    timeout { puts "FAIL: dc motor should clamp to -100"; exit 1 }
}
expect "pynux:/>"

# Test 6: GPIO with 'high' string
send "echo high > /dev/gpio/pin1\r"
expect "OK"
expect "pynux:/>"
send "cat /dev/gpio/pin1\r"
expect {
    "1" { puts "PASS: gpio accepts 'high'" }
    timeout { puts "FAIL: gpio should accept high"; exit 1 }
}
expect "pynux:/>"

# Test 7: GPIO with 'low' string
send "echo low > /dev/gpio/pin1\r"
expect "OK"
expect "pynux:/>"
send "cat /dev/gpio/pin1\r"
expect {
    "0" { puts "PASS: gpio accepts 'low'" }
    timeout { puts "FAIL: gpio should accept low"; exit 1 }
}
expect "pynux:/>"

# Test 8: Multiple rapid writes
send "echo 30 > /dev/motors/servo0\r"
expect "OK"
expect "pynux:/>"
send "echo 60 > /dev/motors/servo0\r"
expect "OK"
expect "pynux:/>"
send "echo 90 > /dev/motors/servo0\r"
expect "OK"
expect "pynux:/>"
send "cat /dev/motors/servo0\r"
expect {
    "90" { puts "PASS: rapid writes work correctly" }
    timeout { puts "FAIL: rapid writes failed"; exit 1 }
}
expect "pynux:/>"

puts "\n=== All edge case tests passed! ==="

send "\003"
close
wait
exit 0
