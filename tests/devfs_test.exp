#!/usr/bin/expect -f
# DevFS Integration Test using Expect

set timeout 10

spawn qemu-system-arm -machine mps2-an385 -cpu cortex-m3 -nographic -semihosting -kernel build/pynux.elf

# Wait for shell prompt
expect {
    "pynux:/>" { }
    timeout { puts "FAIL: Shell prompt not found"; exit 1 }
}

# Test 1: drivers command
send "drivers\r"
expect {
    "/dev/gpio/pin0" { puts "PASS: drivers shows gpio pin0" }
    timeout { puts "FAIL: drivers command failed"; exit 1 }
}
expect {
    "/dev/sensors/temp0" { puts "PASS: drivers shows temp0" }
    timeout { puts "FAIL: drivers should show temp0"; exit 1 }
}
expect {
    "/dev/motors/servo0" { puts "PASS: drivers shows servo0" }
    timeout { puts "FAIL: drivers should show servo0"; exit 1 }
}
expect "pynux:/>"

# Test 2: cat device file
send "cat /dev/sensors/temp0\r"
expect {
    -re {[0-9]+\.[0-9]+} { puts "PASS: cat temp0 returns decimal value" }
    timeout { puts "FAIL: cat temp0 failed"; exit 1 }
}
expect "pynux:/>"

# Test 3: cat GPIO pin
send "cat /dev/gpio/pin0\r"
expect {
    -re {[01]} { puts "PASS: cat gpio returns 0 or 1" }
    timeout { puts "FAIL: cat gpio failed"; exit 1 }
}
expect "pynux:/>"

# Test 4: Write to GPIO
send "echo 1 > /dev/gpio/pin0\r"
expect {
    "OK" { puts "PASS: echo to gpio succeeded" }
    timeout { puts "FAIL: echo to gpio failed"; exit 1 }
}
expect "pynux:/>"

# Test 5: Verify GPIO write
send "cat /dev/gpio/pin0\r"
expect {
    "1" { puts "PASS: gpio pin0 is now 1" }
    timeout { puts "FAIL: gpio should be 1"; exit 1 }
}
expect "pynux:/>"

# Test 6: Write to servo
send "echo 45 > /dev/motors/servo0\r"
expect {
    "OK" { puts "PASS: echo to servo succeeded" }
    timeout { puts "FAIL: echo to servo failed"; exit 1 }
}
expect "pynux:/>"

# Test 7: Read servo
send "cat /dev/motors/servo0\r"
expect {
    "45" { puts "PASS: servo angle is 45" }
    timeout { puts "FAIL: servo should show 45"; exit 1 }
}
expect "pynux:/>"

puts "\n=== All DevFS tests passed! ==="

# Clean exit
send "\003"
close
wait
exit 0
